<html>
<head>
  <style>
  body {
    font-family: helvetica,arial;
  }
  </style>
</head>
<body>
  <h1>Chord Tuning Tool</h1>
  <P>
    <button onclick="setWave('sine')">Sine</button>
    <button onclick="setWave('sawtooth')">Sawtooth</button>
    <button onclick="setWave('square')">Square</button>
  </p>
  <P>
    <button onclick="tuning('5-limit')">5-Limit Just</button>
    <button onclick="tuning('12-tet')">12-TET Equal Temperament</button>
    <button onclick="tuning('3-limit')">3-Limit Pythagorean</button>
    <button onclick="tuning('5-limit-func')">5-Limit functional</button>
  </p>
  <p>
    <button onclick="chord('I')">I</button>
    <button onclick="chord('ii')">ii</button>
    <button onclick="chord('iii')">iii</button>
    <button onclick="chord('IV')">IV</button>
    <button onclick="chord('V')">V</button>
    <button onclick="chord('vi')">vi</button>
    <button onclick="chord('viio')">viio</button>
  </p>
  <p>
    <button onclick="chord('i')">i</button>
    <button onclick="chord('V/V')">V/V</button>
    <button onclick="chord('iv')">iv</button>
    <button onclick="chord('v')">v</button>
    <button onclick="chord('bVI')">bVI</button>
    <button onclick="chord('bVII')">bVII</button>
  </p>
  <p>Third: <span id="third"></span></p>
  <p>Fifth: <span id="fifth"></span></p>
</body>
<script type="text/javascript">

/*
x Play a major triad with web Audio
x Buttons to change tuning of intervals: 12-tet or 5-limit
x Slide to new tuning, dont jump
x choice of waveforms
x Choice of chords
x Display live intervals in cents and ratios
x More tunings
* Chromatic chords on another line: i, II, iv, v, bVI, bVII
* Custom tuning with sliders
*/

try { if (!AudioContext) { throw 1; } } catch(e) { document.getElementById('body').innerHTML = 'Web Audio not supported!'; }

var audio = new AudioContext();

var curTuning = '5-limit';
var curChord = 'I';
var curWave = 'sine';

var generator = 440;

var playNote = function (f) {
  var vco = audio.createOscillator();
  vco.frequency.value = f;
  vco.type = curWave;
  var vca = this.audio.createGain();
  vca.gain.value = 0.24;
  vco.connect(vca);
  vca.connect(audio.destination);
  vco.start(0);
  return vco;
};

var root;
var third;
var fifth;

var P5 = 3/2;
var M3 = 5/4;
var Oc = 2;

var freqs = {
  I: {
    '5-limit': [ generator, generator*M3, generator*P5 ],
    '12-tet': [ generator, generator*Math.pow(2, 4/12), generator*Math.pow(2, 7/12) ],
    '3-limit': [ generator, generator*P5*P5*P5*P5/Oc/Oc, generator*P5 ],
    '5-limit-func': [ generator, generator*M3, generator*P5 ]
  },
  ii: {
    '5-limit': [ generator*P5*P5/Oc/*!*/, generator/P5*Oc, generator/P5*Oc*M3 ],
    '12-tet': [ generator*Math.pow(2, 2/12), generator*Math.pow(2, 5/12), generator*Math.pow(2, 9/12) ],
    '3-limit': [ generator*P5*P5/Oc/*!*/, generator/P5*Oc, generator*P5*P5*P5/Oc ],
    '5-limit-func': [ generator/P5/P5*M3*Oc, generator/P5*Oc, generator/P5*Oc*M3 ]
  },
  iii: {
    '5-limit': [ generator*M3, generator*P5, generator*P5*M3 ],
    '12-tet': [ generator*Math.pow(2, 4/12), generator*Math.pow(2, 7/12), generator*Math.pow(2, 11/12) ],
    '3-limit': [ generator*P5*P5*P5*P5/Oc/Oc, generator*P5, generator*P5*P5*P5*P5*P5/Oc/Oc ],
    '5-limit-func': [ generator*M3, generator*P5, generator*P5*M3 ]
  },
  IV: {
    '5-limit': [ generator/P5*Oc, generator/P5*Oc*M3, generator*Oc ],
    '12-tet': [ generator*Math.pow(2, 5/12), generator*Math.pow(2, 9/12), generator*Math.pow(2, 12/12) ],
    '3-limit': [ generator/P5*Oc, generator*P5*P5*P5/Oc, generator*Oc ],
    '5-limit-func': [ generator/P5*Oc, generator/P5*Oc*M3, generator*Oc ]
  },
  V: {
    '5-limit': [ generator*P5, generator*P5*M3, generator*P5*P5 ],
    '12-tet': [ generator*Math.pow(2, 7/12), generator*Math.pow(2, 11/12), generator*Math.pow(2, 14/12) ],
    '3-limit': [ generator*P5, generator*P5*P5*P5*P5*P5/Oc/Oc, generator*P5*P5 ],
    '5-limit-func': [ generator*P5, generator*P5*M3, generator*P5*P5 ]
  },
  vi: {
    '5-limit': [ generator/P5*Oc*M3, generator*Oc, generator*M3*Oc ],
    '12-tet': [ generator*Math.pow(2, 9/12), generator*Math.pow(2, 12/12), generator*Math.pow(2, 16/12) ],
    '3-limit': [ generator*P5*P5*P5/Oc, generator*Oc, generator*P5*P5*P5*P5/Oc ],
    '5-limit-func': [ generator/P5*Oc*M3, generator*Oc, generator*M3*Oc ]
  },
  viio: {
    '5-limit': [ generator*P5*M3, generator*P5*P5, generator/P5*Oc*Oc ],
    '12-tet': [ generator*Math.pow(2, 11/12), generator*Math.pow(2, 14/12), generator*Math.pow(2, 17/12) ],
    '3-limit': [ generator*P5*P5*P5*P5*P5/Oc/Oc, generator*P5*P5, generator/P5*Oc*Oc ],
    '5-limit-func': [ generator*P5*M3, generator*P5*P5, generator*P5*P5*P5/M3 ]
  },

  i: {
    '5-limit': [ generator, generator/M3*P5, generator*P5 ],
    '12-tet': [ generator, generator*Math.pow(2, 3/12), generator*Math.pow(2, 7/12) ],
    '3-limit': [ generator, generator/P5/P5/P5*Oc*Oc, generator*P5 ],
    '5-limit-func': [ generator, generator/M3*P5, generator*P5 ]
  },
  'V/V': {
    '5-limit': [ generator*P5*P5/Oc/*!*/, generator*P5*P5*M3/Oc, generator/P5*Oc*M3 ],
    '12-tet': [ generator*Math.pow(2, 2/12), generator*Math.pow(2, 6/12), generator*Math.pow(2, 9/12) ],
    '3-limit': [ generator*P5*P5/Oc/*!*/, generator*P5*P5*P5*P5*P5*P5/Oc/Oc/Oc, generator*P5*P5*P5/Oc ],
    '5-limit-func': [ generator*P5*P5/Oc, generator*P5*P5*M3/Oc, generator*P5*P5*P5/Oc ]
  },
  iv: {
    '5-limit': [ generator/P5*Oc, generator/M3*Oc, generator*Oc ],
    '12-tet': [ generator*Math.pow(2, 5/12), generator*Math.pow(2, 8/12), generator*Math.pow(2, 12/12) ],
    '3-limit': [ generator/P5*Oc, generator/P5/P5/P5/P5*Oc*Oc*Oc, generator*Oc ],
    '5-limit-func': [ generator/P5*Oc, generator/M3*Oc, generator*Oc ]
  },
  v: {
    '5-limit': [ generator*P5, generator/P5/P5*Oc*Oc, generator*P5*P5 ],
    '12-tet': [ generator*Math.pow(2, 7/12), generator*Math.pow(2, 10/12), generator*Math.pow(2, 14/12) ],
    '3-limit': [ generator*P5, generator/P5/P5*Oc*Oc, generator*P5*P5 ],
    '5-limit-func': [ generator*P5, generator*P5*P5/M3, generator*P5*P5 ]
  },
  bVI: {
    '5-limit': [ generator/M3*Oc, generator*Oc, generator*P5/M3*Oc ],
    '12-tet': [ generator*Math.pow(2, 8/12), generator*Math.pow(2, 12/12), generator*Math.pow(2, 15/12) ],
    '3-limit': [ generator/P5/P5/P5/P5*Oc*Oc*Oc, generator*Oc, generator/P5/P5/P5*Oc*Oc*Oc ],
    '5-limit-func': [ generator/M3*Oc, generator*Oc, generator*P5/M3*Oc ]
  },
  bVII: {
    '5-limit': [ generator/P5/P5*Oc*Oc, generator*P5*P5, generator/P5*Oc*Oc ],
    '12-tet': [ generator*Math.pow(2, 10/12), generator*Math.pow(2, 14/12), generator*Math.pow(2, 17/12) ],
    '3-limit': [ generator/P5/P5*Oc*Oc, generator*P5*P5, generator/P5*Oc*Oc ],
    '5-limit-func': [ generator/P5/P5*Oc*Oc, generator*P5*P5, generator/P5*Oc*Oc ]
  }
};

chord = function (chord) {
  curChord = chord;
  var notes = freqs[curChord][curTuning];
  if (root) { root.stop(); }
  if (third) { third.stop(); }
  if (fifth) { fifth.stop(); }
  root = playNote(notes[0]);
  third = playNote(notes[1]);
  fifth = playNote(notes[2]);
  tuning(curTuning);
};

tuning = function (tuning) {
  curTuning = tuning;
  var t = audio.currentTime + 1;
  var notes = freqs[curChord][curTuning];
  root.frequency.linearRampToValueAtTime(notes[0], t);
  third.frequency.linearRampToValueAtTime(notes[1], t);
  fifth.frequency.linearRampToValueAtTime(notes[2], t);
};

chord(curChord);


setWave = function (type) {
  curWave = type;
  root.type = curWave;
  third.type = curWave;
  fifth.type = curWave;
};

var cents = function (r) {
  return Math.round(1200 * Math.log2(r));
};

var ratio = function (r) {
  var denom = 1;
  for (denom = 1; denom < 100; denom++) {
    var num = Math.floor(r*denom);
    if (Math.abs(num/denom - r) < 0.00001) {
      return num+'/'+denom;
    }
    num = Math.ceil(r*denom);
    if (Math.abs(num/denom - r) < 0.00001) {
      return num+'/'+denom;
    }
  }
  return '';
};

setInterval(function () {
  var i3 = third.frequency.value / root.frequency.value;
  var i5 = fifth.frequency.value / root.frequency.value;
  document.getElementById('third').innerHTML = cents(i3) + ' cents,  ' + ratio(i3);
  document.getElementById('fifth').innerHTML = cents(i5) + ' cents,  ' + ratio(i5);
}, 100);


  </script>
</body>
</html>
